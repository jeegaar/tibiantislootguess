<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tibiantis ‚Äî Loot Guess (Daily)</title>
<style>
  :root{
    --bg:#0c0f12;--panel:#1a1f24;--text:#e6edf3;--muted:#9aa7b1;
    --accent:#ffcc00;--border:#26323a;--green:#2e7d32;--red:#c62828;
  }
  *{box-sizing:border-box}
  body{
    margin:0;font-family:system-ui,Arial,sans-serif;
    background:linear-gradient(180deg,#0c0f12,#12161a);
    color:var(--text);min-height:100vh;
    display:flex;align-items:center;justify-content:center;padding:24px;
  }
  .app{
    width:100%;max-width:900px;background:var(--panel);
    border:1px solid var(--border);border-radius:12px;padding:18px;
    text-align:center;
  }
  h1{margin:0 0 8px;color:var(--accent);font-size:1.3rem}
  .muted{color:var(--muted);font-size:0.95rem}
  .hidden{display:none}

  #lootArea{display:flex;justify-content:center;gap:12px;flex-wrap:wrap;margin:16px 0}
  .loot-badge{
    padding:10px 14px;border-radius:8px;background:#0f1419;
    border:1px solid var(--border);color:var(--text);font-size:0.9rem;white-space:nowrap
  }

  .row{display:flex;gap:8px;margin:10px 0;align-items:flex-start}
  #guessInput {
    width: 100%;
    max-width: 500px;   /* wider input */
    padding: 10px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: #0f1419;
    color: var(--text);
    flex: 1;
  }
  button{
    padding:10px 14px;
    border-radius:8px;
    border:1px solid var(--border);
    background:#0f1419;
    color:var(--text);
    cursor:pointer
  }

  table{width:100%;border-collapse:collapse;margin-top:10px;text-align:left}
  th,td{padding:8px;border-bottom:1px solid var(--border)}
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;color:#fff;font-size:0.85rem}
  .ok{background:var(--green)} .no{background:var(--red)}

  /* modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);
    display:flex;align-items:center;justify-content:center;z-index:9999}
  .modal{background:var(--panel);padding:20px;border-radius:12px;border:1px solid var(--border);max-width:420px;box-shadow:0 10px 30px rgba(0,0,0,0.5)}
  .modal h2{margin:0 0 8px;color:var(--accent)}

  /* error state */
  .error{border-color:var(--red)!important}
  #errorMsg{color:var(--red);font-size:0.85rem;margin-top:4px;display:none;text-align:left}
</style>
</head>
<body>
<div class="app" role="application" aria-label="Tibiantis Loot Guess ‚Äî Daily">
  <h1>üêâ Guess the Tibiantis Monster (Daily)</h1>
  <div id="dayInfo" class="muted"></div>

  <div id="welcome">
    <p class="muted">Welcome to Guess the Tibiantis monster based on its loot!</p>
    <button id="startBtn">Start the game!</button>
  </div>

  <div id="gameArea" class="hidden">
    <div id="lootArea" aria-label="Revealed loot names"></div>

    <div class="row">
      <input id="guessInput" placeholder="Type monster name and press Enter‚Ä¶" autocomplete="off" />
      <button id="guessBtn">Guess</button>
      <button id="resetBtn">Reset</button>
    </div>
    <span id="errorMsg">This monster doesn't exist</span>

    <table aria-label="Guesses">
      <thead><tr><th>Guess</th><th>Status</th></tr></thead>
      <tbody id="guessesBody"></tbody>
    </table>

    <div id="message" class="muted" role="status" aria-live="polite"></div>
  </div>
</div>

<script>
const MONSTER_LOOT_URL = "/monster_loot.json";

const norm = v => (v ?? "").toString().trim().toLowerCase();

function getWarsawDateKey(){
  const fmt = new Intl.DateTimeFormat('en-CA',{timeZone:'Europe/Warsaw',year:'numeric',month:'2-digit',day:'2-digit'});
  const parts = fmt.formatToParts(new Date());
  return `${parts.find(p=>p.type==='year').value}-${parts.find(p=>p.type==='month').value}-${parts.find(p=>p.type==='day').value}`;
}
function hashStr(s){ let h=2166136261>>>0; for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h=Math.imul(h,16777619);} return h>>>0;}
function makePRNG(seed){ let x=seed||123456789; return()=>{x^=x<<13;x^=x>>>17;x^=x<<5;return(x>>>0)/4294967296;};}
function seededPick(arr,prng){return arr.length?arr[Math.floor(prng()*arr.length)]:undefined;}
function seededShuffle(a,prng){for(let i=a.length-1;i>0;i--){const j=Math.floor(prng()*(i+1));[a[i],a[j]]=[a[j],a[i]];}}

let MONSTERS={},MONSTER_NAMES=[],TARGET=null,TARGET_DISPLAY=null,LOOT=[],revealed=0,tries=0,solved=false;

const DATE_KEY=getWarsawDateKey();
const STORAGE_KEY='tibiantis_loot_daily_'+DATE_KEY;

const dayInfo=document.getElementById('dayInfo');
const welcome=document.getElementById('welcome');
const gameArea=document.getElementById('gameArea');
const lootArea=document.getElementById('lootArea');
const guessInput=document.getElementById('guessInput');
const errorMsg=document.getElementById('errorMsg');
const guessesBody=document.getElementById('guessesBody');
const messageBox=document.getElementById('message');

function saveState(){
  const rows=Array.from(guessesBody.querySelectorAll('tr')).map(tr=>({guess:tr.children[0]?.textContent??'',ok:tr.querySelector('.badge')?.classList.contains('ok')??false}));
  const data={revealed,tries,solved,rows};
  try{localStorage.setItem(STORAGE_KEY,JSON.stringify(data));}catch(e){}
}
function loadState(){try{const raw=localStorage.getItem(STORAGE_KEY);return raw?JSON.parse(raw):null;}catch(e){return null;}}

function setMessage(text){messageBox.textContent=text||'';}
function addLootBadge(name){const div=document.createElement('div');div.className='loot-badge';div.textContent=name;lootArea.appendChild(div);}
function revealNext(){
  if(LOOT.length===0){lootArea.textContent="This monster doesn't loot a thing!!!";return;}
  if(revealed>=LOOT.length){lootArea.appendChild(Object.assign(document.createElement('div'),{className:'loot-badge',textContent:"This monster doesn't loot anything else!"}));return;}
  addLootBadge(LOOT[revealed++]);
}
function addGuessRow(text,ok){
  const tr=document.createElement('tr');
  const td1=document.createElement('td');td1.textContent=text;
  const td2=document.createElement('td');
  const b=document.createElement('span');b.className='badge '+(ok?'ok':'no');b.textContent=ok?'Correct':'Wrong';
  td2.appendChild(b);tr.appendChild(td1);tr.appendChild(td2);guessesBody.prepend(tr);
}
function showModalSolved(){
  const backdrop=document.createElement('div');backdrop.className='modal-backdrop';
  const modal=document.createElement('div');modal.className='modal';
  const h=document.createElement('h2');h.textContent='Congratulations!';
  const p=document.createElement('p');p.textContent=`You guessed it in ${tries} ${tries===1?'try':'tries'}!`;
  const btn=document.createElement('button');btn.textContent='Close';btn.addEventListener('click',()=>document.body.removeChild(backdrop));
  modal.appendChild(h);modal.appendChild(p);modal.appendChild(btn);backdrop.appendChild(modal);document.body.appendChild(backdrop);
}

async function loadMonsters(){
  const r=await fetch(MONSTER_LOOT_URL,{cache:'no-store'});
  if(!r.ok)throw new Error('Could not load monster_loot.json');
  const data=await r.json();MONSTERS=data;MONSTER_NAMES=Object.keys(MONSTERS);
}
function setupToday(){
  const seed=hashStr('TIBIANTIS'+DATE_KEY);
  const rng=makePRNG(seed);
  TARGET_DISPLAY=seededPick(MONSTER_NAMES,rng)||'';TARGET=norm(TARGET_DISPLAY);
  const lootRaw=Array.isArray(MONSTERS[TARGET_DISPLAY])?MONSTERS[TARGET_DISPLAY].slice():[];
  const lootSeed=hashStr(DATE_KEY+'|'+TARGET_DISPLAY);const lootRng=makePRNG(lootSeed);
  seededShuffle(lootRaw,lootRng);LOOT=lootRaw;revealed=0;tries=0;solved=false;
}
function restoreStateIfAny(){
  const state=loadState();if(!state)return false;
  revealed=Math.min(state.revealed||0,LOOT.length);tries=state.tries||0;solved=!!state.solved;
  lootArea.innerHTML='';if(LOOT.length===0)lootArea.textContent="This monster doesn't loot a thing!!!";
  else for(let i=0;i<revealed;i++)addLootBadge(LOOT[i]);
  guessesBody.innerHTML='';(state.rows||[]).slice().reverse().forEach(r=>addGuessRow(r.guess,r.ok));
  if(solved){setMessage(`üéâ Already solved today. The monster is ${TARGET_DISPLAY}.`);guessInput.disabled=true;document.getElementById('guessBtn').disabled=true;}
  return true;
}
async function startGame(){
  welcome.classList.add('hidden');gameArea.classList.remove('hidden');
  dayInfo.textContent=`Day: ${DATE_KEY} (Europe/Warsaw)`;
  try{await loadMonsters();}catch(e){setMessage('Error loading data.');return;}
  setupToday();const restored=restoreStateIfAny();if(!restored){revealNext();saveState();}
}
function clearError(){guessInput.classList.remove('error');errorMsg.style.display='none';}
function showError(msg){guessInput.classList.add('error');errorMsg.textContent=msg;errorMsg.style.display='block';}
function onGuess(){
  if(!TARGET)return;
  const raw=guessInput.value.trim();const g=norm(raw);if(!g)return;
  if(!MONSTER_NAMES.map(norm).includes(g)){showError("This monster doesn't exist");return;}
  clearError();tries++;const ok=(g===TARGET);addGuessRow(raw,ok);
  if(ok){solved=true;setMessage(`üéâ Correct! The monster is ${TARGET_DISPLAY}.`);showModalSolved();guessInput.disabled=true;document.getElementById('guessBtn').disabled=true;}
  else{if(revealed<LOOT.length)revealNext();else{const last=lootArea.lastElementChild;if(!last||last.textContent!=="This monster doesn't loot anything else!"){lootArea.appendChild(Object.assign(document.createElement('div'),{className:'loot-badge',textContent:"This monster doesn't loot anything else!"}));}}}
  guessInput.value='';saveState();
}
function resetGame(){
  revealed=0;tries=0;solved=false;
  guessesBody.innerHTML='';lootArea.innerHTML='';
  guessInput.disabled=false;document.getElementById('guessBtn').disabled=false;
  clearError();setMessage('');
  if(LOOT.length===0)lootArea.textContent="This monster doesn't loot a thing!!!";else revealNext();
  saveState();
}
document.getElementById('startBtn').addEventListener('click',startGame);
document.getElementById('guessBtn').addEventListener('click',onGuess);
document.getElementById('resetBtn').addEventListener('click',resetGame);
guessInput.addEventListener('keydown',e=>{if(e.key==="Enter")onGuess();});
guessInput.addEventListener('input',clearError);
</script>
</body>
</html>
