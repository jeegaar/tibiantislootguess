<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tibiantis ‚Äî Loot Guess</title>
<style>
  :root{
    --bg:#0c0f12;--panel:#1a1f24;--text:#e6edf3;--muted:#9aa7b1;
    --green:#2e7d32;--red:#c62828;--accent:#ffcc00;--border:#26323a;
  }
  *{box-sizing:border-box}
  body{
    margin:0;font-family:system-ui,Arial,sans-serif;background:linear-gradient(180deg,#0c0f12,#12161a);
    color:var(--text);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px;
  }
  .app{width:100%;max-width:900px;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:18px;}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
  h1{margin:0;color:var(--accent);display:flex;gap:10px;align-items:center;font-size:1.2rem;}
  .help{color:var(--muted);font-size:0.95rem;margin-bottom:10px;text-align:center}
  .hidden{display:none}

  /* Controls */
  .row{display:grid;grid-template-columns:1fr auto auto;gap:8px;margin-top:10px}
  input[type=text]{padding:10px;border-radius:8px;border:1px solid var(--border);background:#0f1419;color:var(--text)}
  button{padding:10px 12px;border-radius:8px;border:1px solid var(--border);background:#0f1419;color:var(--text);cursor:pointer}

  /* Loot strip */
  #lootArea{
    display:flex;justify-content:center;align-items:center;gap:12px;
    margin:18px 0 6px 0;flex-wrap:wrap;
  }
  #lootArea figure{
    margin:0;display:flex;flex-direction:column;align-items:center;gap:6px
  }
  #lootArea img{
    width:48px;height:48px;object-fit:contain;
    border:1px solid var(--border);border-radius:8px;background:#0f1419;padding:6px;
  }
  /* Text badge fallback (shown when icon missing) */
  .loot-badge{
    min-width:48px;min-height:48px;display:flex;align-items:center;justify-content:center;
    padding:8px 10px;border:1px solid var(--border);border-radius:8px;background:#0f1419;
    font-size:0.8rem;color:var(--text);text-align:center;white-space:nowrap;
  }
  #lootArea figcaption{font-size:0.7rem;color:var(--muted)}

  /* Table */
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px;border-bottom:1px solid var(--border);text-align:left}
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;color:#fff;font-size:0.85rem}
  .ok{background:var(--green)}.no{background:var(--red)}

  /* Modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:9999}
  .modal{background:var(--panel);padding:20px;border-radius:12px;border:1px solid var(--border);max-width:420px;box-shadow:0 10px 30px rgba(0,0,0,0.5);text-align:center}
  .modal h2{margin:0 0 8px;color:var(--accent)}.modal p{margin:0 0 12px}
  .modal button{padding:8px 12px;border-radius:8px}

  #message{margin-top:10px}
  #welcome{display:flex;flex-direction:column;align-items:center;gap:10px;text-align:center}
</style>
</head>
<body>
  <div class="app" role="application" aria-label="Tibiantis Loot Guess">
    <header>
      <h1>üêâ Tibiantis ‚Äî Loot Guess</h1>
      <div style="color:var(--muted);font-size:0.95rem" id="dayInfo"></div>
    </header>

    <div id="welcome">
      <div class="help">Welcome to Guess the Tibiantis monster based on its loot!</div>
      <button id="startBtn">Start the game!</button>
    </div>

    <div id="gameArea" class="hidden">
      <div class="help">A random item from today‚Äôs monster will appear. If your guess is wrong, the next item appears (to the right). Case doesn‚Äôt matter.</div>

      <div id="lootArea" aria-label="Revealed loot icons or names"></div>

      <div class="row">
        <input id="guessInput" placeholder="Type a creature name and press Enter‚Ä¶" autocomplete="off" />
        <button id="guessBtn">Guess</button>
        <button id="resetBtn" title="Clear today‚Äôs progress">Reset</button>
      </div>

      <table aria-label="Guesses">
        <thead><tr><th>Name</th><th>Status</th></tr></thead>
        <tbody id="guessesBody"></tbody>
      </table>

      <div id="message" role="status" aria-live="polite"></div>
    </div>
  </div>

<script>
/* ===== Config (files at repo root on Netlify) ===== */
const ITEMS_URL = "/items.json";              // { "gold coin": "icons/goldcoin.png", ... }
const MONSTER_LOOT_URL = "/monster_loot.json"; // { "rat": ["gold coin","cheese"], ... }

/* ===== Utilities ===== */
const norm = v => (v ?? '').toString().trim().toLowerCase();

function getWarsawDateKey(){
  const fmt = new Intl.DateTimeFormat('en-CA', { timeZone:'Europe/Warsaw', year:'numeric', month:'2-digit', day:'2-digit' });
  const parts = fmt.formatToParts(new Date());
  const y = parts.find(p=>p.type==='year').value;
  const m = parts.find(p=>p.type==='month').value;
  const d = parts.find(p=>p.type==='day').value;
  return `${y}-${m}-${d}`; // YYYY-MM-DD
}
function hashStr(s){ let h=2166136261>>>0; for(let i=0;i<s.length;i++){ h ^= s.charCodeAt(i); h=Math.imul(h,16777619);} return h>>>0; }
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }

/* ===== State ===== */
let ITEMS = null;              // null if items.json not found; else {lowerName: iconPath}
let MONSTER_LOOT = {};         // {lowerMonster: [lowerItem,...]}
let MONSTER_NAMES = [];        // [lowerMonster,...]
let TARGET = null;             // lower-case monster name
let LOOT_LIST = [];            // [{name, icon|null}]
let revealed = 0;
let solved = false;

const DATE_KEY = getWarsawDateKey();
const STORAGE_KEY = 'tibiantis_loot_' + DATE_KEY;

/* ===== DOM ===== */
const dayInfo = document.getElementById('dayInfo');
const welcome = document.getElementById('welcome');
const gameArea = document.getElementById('gameArea');
const lootArea = document.getElementById('lootArea');
const guessInput = document.getElementById('guessInput');
const guessBtn = document.getElementById('guessBtn');
const resetBtn = document.getElementById('resetBtn');
const guessesBody = document.getElementById('guessesBody');
const messageBox = document.getElementById('message');

/* ===== Persistence ===== */
function saveState(){
  const rows = Array.from(guessesBody.querySelectorAll('tr')).map(tr => {
    const name = tr.children[0]?.textContent ?? '';
    const ok = tr.querySelector('.badge')?.classList.contains('ok') ?? false;
    return { name, ok };
  });
  const data = { revealed, solved, rows };
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }catch(e){}
}
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(e){ return null; }
}
function clearToday(){ try{ localStorage.removeItem(STORAGE_KEY); }catch(e){} }

/* ===== UI helpers ===== */
function showMessage(text, type){
  messageBox.className = type || '';
  messageBox.textContent = text || '';
}
function clearMessage(){ showMessage('', ''); }

function addGuessRow(name, correct){
  const tr = document.createElement('tr');
  const tdName = document.createElement('td'); tdName.textContent = name;
  const tdStatus = document.createElement('td');
  const badge = document.createElement('span');
  badge.className = 'badge ' + (correct ? 'ok' : 'no');
  badge.textContent = correct ? 'Correct' : 'Wrong';
  tdStatus.appendChild(badge);
  tr.appendChild(tdName); tr.appendChild(tdStatus);
  guessesBody.prepend(tr);
}

function showWinModal(guessesCount){
  const backdrop = document.createElement('div'); backdrop.className='modal-backdrop';
  const modal = document.createElement('div'); modal.className='modal';
  const h = document.createElement('h2'); h.textContent = 'You Guessed Right!';
  const p = document.createElement('p'); p.textContent = `Solved in ${guessesCount} ${guessesCount===1?'guess':'guesses'}!`;
  const btn = document.createElement('button'); btn.textContent='Close';
  btn.addEventListener('click', ()=>document.body.removeChild(backdrop));
  modal.appendChild(h); modal.appendChild(p); modal.appendChild(btn);
  backdrop.appendChild(modal);
  document.body.appendChild(backdrop);
}

function prettyName(s){
  return (s||'').split(/(\s|-|')/).map(part => /[a-z]/i.test(part) ? part.charAt(0).toUpperCase()+part.slice(1) : part).join('');
}

/* ===== Loot rendering (icon if available else text badge) ===== */
function renderLootTile(item){
  const fig = document.createElement('figure');

  if (item.icon) {
    const img = document.createElement('img');
    img.src = item.icon;
    img.alt = item.name;
    img.title = item.name;
    // If the icon 404s, swap to a text badge (no blocking)
    img.onerror = () => {
      fig.innerHTML = '';
      const badge = document.createElement('div');
      badge.className = 'loot-badge';
      badge.textContent = item.name;
      fig.appendChild(badge);
    };
    fig.appendChild(img);
  } else {
    const badge = document.createElement('div');
    badge.className = 'loot-badge';
    badge.textContent = item.name;
    fig.appendChild(badge);
  }
  return fig;
}

function revealNextLoot(){
  if(revealed >= LOOT_LIST.length){
    showMessage('No more loot hints. Keep trying!', 'info');
    return;
  }
  const item = LOOT_LIST[revealed++];
  lootArea.appendChild(renderLootTile(item));
}

/* ===== Data loading ===== */
async function fetchJSON(url){
  const r = await fetch(url, { cache:'no-store' });
  if(!r.ok) throw new Error(`HTTP ${r.status} for ${url}`);
  return r.json();
}

async function loadMonsterLoot(){
  const raw = await fetchJSON(MONSTER_LOOT_URL);
  const out = {};
  Object.keys(raw).forEach(mon => {
    out[norm(mon)] = (raw[mon] || []).map(n => norm(n));
  });
  return out;
}

/* items.json is OPTIONAL ‚Äî if missing, we still run with text badges */
async function tryLoadItems(){
  try{
    const raw = await fetchJSON(ITEMS_URL);          // {"gold coin":"icons/goldcoin.png", ...}
    const out = {};
    Object.keys(raw).forEach(name => { out[norm(name)] = raw[name]; });
    return out;
  } catch(e){
    console.warn('items.json not found/failed ‚Äî falling back to text badges only.', e);
    return null;
  }
}

async function initData(){
  MONSTER_LOOT = await loadMonsterLoot();
  ITEMS = await tryLoadItems();

  MONSTER_NAMES = Object.keys(MONSTER_LOOT).sort();
  if(!MONSTER_NAMES.length) throw new Error('monster_loot.json is empty.');

  const idx = hashStr(DATE_KEY) % MONSTER_NAMES.length;
  TARGET = MONSTER_NAMES[idx];

  const lootNames = MONSTER_LOOT[TARGET] || [];
  LOOT_LIST = lootNames.map(name => ({
    name,
    icon: ITEMS ? (ITEMS[name] || null) : null
  }));
  shuffle(LOOT_LIST);
}

/* ===== Game flow ===== */
async function startGame(){
  clearMessage();
  dayInfo.textContent = 'Day: ' + DATE_KEY + ' (Europe/Warsaw)';

  // Immediately show the game UI so the button always "does something"
  welcome.classList.add('hidden');
  gameArea.classList.remove('hidden');
  showMessage('Loading data‚Ä¶', 'info');

  try{
    await initData();
  } catch(err){
    console.error(err);
    showMessage('Error loading data. Ensure both files exist at repo root: items.json (optional) and monster_loot.json (required).', 'error');
    return;
  }

  clearMessage();

  // Restore state (if any), otherwise reveal the first loot item
  const state = loadState();
  if(state){
    revealed = Math.min(state.revealed || 0, LOOT_LIST.length);
    solved = !!state.solved;
    // Reveal previously shown items
    for(let i=0;i<revealed;i++) lootArea.appendChild(renderLootTile(LOOT_LIST[i]));
    // Restore guesses
    (state.rows || []).slice().reverse().forEach(r => addGuessRow(r.name, r.ok));
    if(solved){
      showMessage('üéâ Already solved today. The creature is ' + prettyName(TARGET) + '.', 'winner');
      disableInput(true);
      return;
    }
    if(revealed === 0) { revealNextLoot(); }
  } else {
    revealNextLoot();
    saveState();
  }
}

function disableInput(dis=true){
  guessInput.disabled = dis;
  guessBtn.disabled = dis;
}

function makeGuess(){
  if(!TARGET) return;
  clearMessage();
  const input = guessInput.value.trim();
  if(!input) return;

  const guessNorm = norm(input);

  // Validate against known monsters (keys of monster_loot.json), like the first game did
  const isKnown = MONSTER_LOOT.hasOwnProperty(guessNorm);
  if(!isKnown){
    showMessage(`Unknown creature: "${input}"`, 'error');
    return;
  }

  const correct = (guessNorm === TARGET);
  addGuessRow(input, correct);

  if(correct){
    solved = true;
    showMessage('üéâ You guessed it! Today\'s creature is ' + prettyName(TARGET) + '.', 'winner');
    showWinModal(Array.from(guessesBody.querySelectorAll('tr')).length);
    disableInput(true);
  } else {
    revealNextLoot();
  }
  guessInput.value = '';
  saveState();
}

/* ===== Wire up ===== */
document.getElementById('startBtn').addEventListener('click', startGame);
guessBtn.addEventListener('click', makeGuess);
guessInput.addEventListener('keydown', e => { if(e.key === 'Enter') makeGuess(); });

resetBtn.addEventListener('click', ()=>{
  clearToday();
  // Reset UI for the current day (keep the same daily monster)
  guessesBody.innerHTML = '';
  lootArea.innerHTML = '';
  revealed = 0;
  solved = false;
  disableInput(false);
  clearMessage();
  revealNextLoot();
  saveState();
});
</script>
</body>
</html>
